<% if (!partial) { %>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar - Productivity Tracker</title>
  
  <link rel="preload" href="/css/style.css" as="style">
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="icon" href="/images/icon.svg" type="image/svg+xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <style>
    #calendar-container { position: relative;
      min-height: 400px; }
    .loader-overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(10, 10, 10, 0.7); display: none;
      justify-content: center; align-items: center; z-index: 10;
      border-radius: 20px;
      backdrop-filter: blur(2px);
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid rgba(255, 215, 0, 0.1);
      border-top: 4px solid #FFD700; border-radius: 50%;
      animation: spin 1s linear infinite;
      will-change: transform;
      /* üöÄ Optimization: Hardware Acceleration */
    }
    @keyframes spin { 0% { transform: rotate(0deg);
      } 100% { transform: rotate(360deg); } }
    
    /* Header Layout */
    .calendar-header { 
      display: flex;
      flex-direction: column; align-items: center; 
      gap: 5px; margin-bottom: 20px; width: 100%;
    }

    /* New Tools Row for the Download Button */
    .tools-row {
      width: 100%;
      display: flex; justify-content: flex-end; 
      padding: 0 5px; margin-bottom: -10px; 
    }

    /* Clean Button Styles */
    .download-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%; cursor: pointer;
        width: 36px; height: 36px; color: #888;
        display: flex;
        align-items: center; justify-content: center;
        transition: all 0.2s ease;
    }

    .download-btn:hover {
        background: rgba(255, 215, 0, 0.1);
        color: #FFD700;
        border-color: rgba(255, 215, 0, 0.3); transform: scale(1.05);
    }
    
    .download-btn svg { width: 18px;
      height: 18px; }

    /* Navigation Row */
    .header-main { 
      display: flex;
      justify-content: space-between; 
      align-items: center; width: 100%; position: relative;
    }
    
    .month-summary { 
      display: flex;
      justify-content: center; gap: 8px; 
      width: 100%; max-width: 500px; margin-top: 10px;
    }
    
    .summary-item { 
      background: rgba(255, 215, 0, 0.1);
      padding: 8px 4px; 
      border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3); 
      flex: 1; min-width: 0; display: flex; flex-direction: column;
      align-items: center; 
    }
    
    .summary-label { 
      color: #b0b0b0;
      font-size: 0.65rem; text-transform: uppercase; 
      letter-spacing: 0.5px; margin-bottom: 2px; text-align: center;
    }
    
    .summary-value { 
      color: #FFD700; font-weight: bold;
      font-size: 0.95rem; 
    }

    .calendar-view {
        background-color: #121212; padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    @media (max-width: 480px) {
      .calendar-view { padding: 15px 10px;
      }
      .summary-item { padding: 6px 2px;
      }
      .summary-value { font-size: 0.8rem; }
      .summary-label { font-size: 0.55rem;
      letter-spacing: 0; }
      .calendar-header h2 { font-size: 1.2rem;
      }
      .month-summary { gap: 5px;
      }
    }
  </style>
</head>
<body>
  <%- include('partials/loader') %>
  <nav class="navbar">
    <h2>Productivity Tracker</h2>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/calendar" class="active">‚≠êÔ∏è Calendar</a>
      <a href="/analytics">Analytics</a>
      <a href="/settings">Settings</a>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <div class="container">
    <h1>Study Hour Calendar</h1>
    <a href="https://stopwatch-theta-sooty.vercel.app/" target="_blank" style="display: inline-block; text-decoration: none; padding: 5px; color:#ffd900; background-color: rgba(255, 255, 255, 0.1); border: 1px solid white; border-radius: 10px;"><span>‚è±</span> 
      Start Stopwatch</a>
    <br><br>
    
    <div class="add-log-form">
      <h2>Add/Update Hours</h2>
      <% if (error) { %>
        <div class="error" style="margin-bottom: 20px;"><%= error %></div>
      <% } %>
      <form id="logForm">
        <div class="form-row">
          <div class="form-group">
            <label for="date">Date</label>
        
            <input type="date" id="date" name="date" required>
          </div>
          <div class="form-group">
            <label for="hours">Hours</label>
            <input type="number" id="hours" name="hours" step="0.5" min="0" max="24" required>
          </div>
        </div>
        <button type="submit" class="btn">Save</button>
      </form>
    </div>

  
    <div id="calendar-container">
      <div class="loader-overlay" id="loader"><div class="spinner"></div></div>
      
      <div id="calendar-content" class="calendar-view">
<% } %>

        <% 
          const getMonthString = (date) => {
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
          };
          const prevMonthDate = new Date(currentMonth);
          prevMonthDate.setUTCMonth(prevMonthDate.getUTCMonth() - 1);
          const prevMonthString = getMonthString(prevMonthDate);

          const nextMonthDate = new Date(currentMonth);
          nextMonthDate.setUTCMonth(nextMonthDate.getUTCMonth() + 1);
          const nextMonthString = getMonthString(nextMonthDate);
          const todayDate = new Date();
          const isFutureMonth = nextMonthDate.getUTCFullYear() > todayDate.getUTCFullYear() || 
                              (nextMonthDate.getUTCFullYear() === todayDate.getUTCFullYear() && nextMonthDate.getUTCMonth() > todayDate.getUTCMonth());
          const getHeatmapColor = (hours, goal) => {
            if (hours === 0) return 'rgba(220, 53, 69, 0.9)';
            if (hours < goal) {
                const opacity = 0.8 - (hours / goal) * 0.6;
                return `rgba(220, 53, 69, ${opacity.toFixed(2)})`;
            }
            const excessPercentage = (hours / goal);
            if (excessPercentage < 1.25) return '#39d353';
            if (excessPercentage < 1.75) return '#26a641';
            if (excessPercentage < 2.5) return '#006d32';
            return '#0e4429';
          };
        %>

        <div class="calendar-header">
            <div class="tools-row">
                <button id="download-calendar-btn" class="download-btn" title="Download Calendar Image" data-html2canvas-ignore="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path 
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
            
                </button>
            </div>

            <div class="header-main">
                <a href="/calendar?month=<%= prevMonthString %>" class="month-nav">&larr;</a>
                <h2><%= currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' }) %></h2>
                <a href="<%= isFutureMonth ? '#' : '/calendar?month=' + nextMonthString %>" 
                class="month-nav <%= isFutureMonth ? 'disabled' : '' %>">&rarr;</a>
            </div>
          
            <div class="month-summary">
                <div class="summary-item">
                    <span class="summary-label">Total Hours</span>
                    <span class="summary-value" id="monthTotal">0.0h</span>
 
                </div>
            
                <div class="summary-item">
                    <span class="summary-label">Days Logged</span>
                    <span class="summary-value" id="monthDays">0</span>
            
                </div>
                <div class="summary-item">
                    <span class="summary-label">Avg/Day</span>
                    <span class="summary-value" id="monthAvg">0.00h</span>
                </div>
            </div>
        
        </div>

        <div class="calendar-grid">
          <% 
            const daysInMonth = new Date(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
              const log = logs.find(l => new Date(l.date).getUTCDate() === day);
              const hasLog = log !== undefined;
              const hours = hasLog ? log.hours : -1;
              const color = hasLog ? getHeatmapColor(hours, user.dailyGoalHours) : '#2a2a2a';
          %>
            <div class="calendar-day" style="background-color: <%= color %>;">
              <div class="day-number"><%= day %></div>
              <% if (hasLog) { %>
                <div class="day-hours" style="border: 1px solid white; border-radius: 10%; padding:5px ">
                  <%= hours.toFixed(1) %>h
                </div>
              <% } %>
            </div>
          <% } %>
        </div>

<% if (!partial) { %>
      </div> </div> <div class="legend">
        <div class="legend-item">
            <span class="legend-text">0 hours</span>
            <span class="legend-color" style="background-color: rgba(220, 53, 69, 0.9);"></span>
            <span class="legend-color" style="background-color: rgba(220, 53, 69, 0.2);"></span>
            <span class="legend-text">Near Goal</span>
        </div>
        <div class="legend-item">
            <span class="legend-text">Goal Met</span>
            <span class="legend-color" style="background-color: #39d353;"></span>
   
            <span class="legend-color" style="background-color: #26a641;"></span>
            <span class="legend-color" style="background-color: #006d32;"></span>
            <span class="legend-color" style="background-color: #0e4429;"></span>
            <span class="legend-text">Exceeded</span>
        </div>
    </div>
  </div>

  <script>
    const loader = document.getElementById('loader');
    const content = document.getElementById('calendar-content');
    const logForm = document.getElementById('logForm');

    async function updateCalendar(monthParam = '') {
      loader.style.display = 'flex';
      try {
        const response = await fetch(`/calendar?month=${monthParam}&partial=true`);
        const html = await response.text();
        content.innerHTML = html;
        calculateMonthStats();
      } catch (err) {
        console.error('Update failed', err);
      } finally {
        loader.style.display = 'none';
      }
    }

    logForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Select the submit button
      const submitBtn = logForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerText;
      
      // Change button state to "Saving..."
      submitBtn.innerText = 'Saving...';
      submitBtn.disabled = true;

      const formData = new URLSearchParams(new FormData(logForm));
      loader.style.display = 'flex';
      try {
        const response = await fetch('/add-study-log', {
          method: 'POST', body: formData,
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        await updateCalendar(urlParams.get('month') || '');
        logForm.reset();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
      } finally {
        loader.style.display = 'none';
        
        // Revert button state
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
      }
    });
    
    document.addEventListener('click', (e) => {
      // Navigation
      const navLink = e.target.closest('.month-nav');
      if (navLink && navLink.getAttribute('href') !== '#') {
        e.preventDefault();
        const url = new URL(navLink.href, window.location.origin);
        const month = url.searchParams.get('month');
        window.history.pushState({}, '', navLink.href);
        updateCalendar(month || '');
      }

      // Download Functionality
   
      const downloadBtn = e.target.closest('#download-calendar-btn');
      if (downloadBtn) {
        e.preventDefault();
        const element = document.getElementById('calendar-content');
        
        const loader = document.getElementById('loader');
        if(loader) loader.style.display = 'flex';

        // Check if html2canvas is loaded (since we deferred it)
        if (typeof html2canvas !== 'undefined') {
       
             executeDownload(element, loader);
        } else {
             // Fallback/Retry if clicked immediately
             console.log("Waiting for html2canvas...");
             setTimeout(() => {
                 if (typeof html2canvas !== 'undefined') executeDownload(element, loader);
                 else {
                     alert("Feature is still loading. Please try again in a moment.");
                     if(loader) loader.style.display = 'none';
   
                 }
             }, 1000);
        }
      }
    });
    function executeDownload(element, loader) {
        html2canvas(element, {
            scale: 2,
            backgroundColor: '#121212',
            logging: false,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
           
            link.download = 'productivity-calendar-' + new Date().toISOString().split('T')[0] + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            if(loader) loader.style.display = 'none';
        }).catch(err => {
            console.error('Screenshot failed:', err);
            if(loader) loader.style.display = 'none';
        });
    }

    function calculateMonthStats() {
      const hourElements = document.querySelectorAll('.day-hours');
      let total = 0, days = 0;
      hourElements.forEach(el => {
        const h = parseFloat(el.innerText.replace('h', ''));
        if (!isNaN(h)) { total += h; days++; }
      });
      document.getElementById('monthTotal').innerText = total.toFixed(1) + 'h';
      document.getElementById('monthDays').innerText = days;
      document.getElementById('monthAvg').innerText = (days > 0 ? total/days : 0).toFixed(2) + 'h';
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Run stats calculation immediately on load
        calculateMonthStats();
        const todayString = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date');
        if(dateInput) {
            dateInput.value = todayString;
            dateInput.setAttribute('max', todayString);
        }
    
    });
  </script>
</body>
</html>
<% } %>