<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Achievements - Productivity Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" href="/images/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <style>
    /* --- ULTIMATE UI/UX UPGRADE --- */
    :root {
      --gold-primary: #FFD700;
      --gold-dim: #C5A000;
      --gold-glow: 0 0 25px rgba(255, 215, 0, 0.2);
      --bg-dark: #0a0a0a;
      --card-glass: rgba(22, 22, 22, 0.7);
      --card-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-sub: #a1a1aa;
      --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body {
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(255, 215, 0, 0.03), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(255, 215, 0, 0.03), transparent 25%);
    }

    /* --- HERO STATS --- */
    .achievements-hero {
      text-align: center;
      padding: 50px 0 40px;
    }

    .hero-title {
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 30px;
      background: linear-gradient(to bottom, #fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .stats-deck {
      display: inline-flex;
      background: rgba(30, 30, 30, 0.5);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      padding: 15px 40px;
      gap: 50px;
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
    }

    .stat-unit {
      text-align: center;
    }

    .stat-num {
      display: block;
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1;
      margin-bottom: 5px;
    }
    
    .stat-num.highlight {
      color: var(--gold-primary);
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .stat-desc {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-sub);
      font-weight: 600;
    }

    /* --- SECTION HEADERS --- */
    .category-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 60px 0 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }

    .category-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .category-icon-box {
      width: 40px;
      height: 40px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
      font-size: 1.2rem;
    }

    /* --- CARD GRID --- */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
    }

    /* --- ACHIEVEMENT CARD --- */
    .ach-card {
      position: relative;
      background: linear-gradient(145deg, rgba(30,30,30,0.9), rgba(20,20,20,0.95));
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 25px;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .ach-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border-color: rgba(255, 215, 0, 0.15);
    }

    /* Unlocked State */
    .ach-card.unlocked {
      background: linear-gradient(145deg, rgba(40,36,20,0.4), rgba(20,20,20,0.9));
      box-shadow: inset 0 0 0 1px rgba(255, 215, 0, 0.1), 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .ach-card.unlocked::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .ach-icon-wrapper {
      font-size: 2.5rem;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
    }
    
    .ach-card:not(.unlocked) .ach-icon-wrapper {
      filter: grayscale(1) opacity(0.4);
    }

    .status-badge {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-badge.completed {
      background: rgba(255, 215, 0, 0.15);
      color: var(--gold-primary);
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .card-content h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      margin: 10px 0 5px;
    }

    .ach-card:not(.unlocked) .card-content h3 {
      color: var(--text-sub);
    }

    .card-content p {
      font-size: 0.85rem;
      color: var(--text-sub);
      line-height: 1.5;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Action Button (The trigger) */
    .btn-view-card {
      margin-top: auto;
      width: 100%;
      padding: 10px 0;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px;
      background: transparent;
      color: var(--gold-primary);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-view-card:hover {
      background: var(--gold-primary);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    /* Progress Bar for Locked */
    .progress-track {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-top: 15px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--gold-primary);
      box-shadow: 0 0 10px var(--gold-primary);
      border-radius: 4px;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.75rem;
      color: var(--text-sub);
      font-weight: 600;
    }

    /* --- THE ULTIMATE POPUP (MODAL) --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      z-index: 9999;
      /* Higher than navbar, lower than confetti */
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-card {
      background: #111;
      width: 90%;
      max-width: 420px;
      border-radius: 30px;
      position: relative;
      padding: 40px;
      text-align: center;
      border: 1px solid rgba(255, 215, 0, 0.2);
      box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8), 
                  0 0 0 1px rgba(255, 255, 255, 0.05);
      animation: scaleUp 0.5s var(--ease-out-back);
      overflow: hidden;
    }

    /* Lighting Effect behind the icon */
    .god-ray {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
      filter: blur(20px);
      z-index: 0;
      pointer-events: none;
    }

    .modal-header-badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 800;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gold-primary);
      margin-bottom: 25px;
      padding: 6px 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 50px;
      background: rgba(255, 215, 0, 0.05);
      position: relative;
      z-index: 1;
    }

    .modal-icon-lg {
      font-size: 5rem;
      position: relative;
      z-index: 1;
      margin-bottom: 20px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
      animation: float 3s ease-in-out infinite;
    }

    .modal-title {
      font-size: 2rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
      line-height: 1.1;
    }

    .modal-desc {
      font-size: 1rem;
      color: #bbb;
      line-height: 1.6;
      margin-bottom: 25px;
      position: relative;
      z-index: 1;
    }

    .modal-meta-box {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      z-index: 1;
    }

    .meta-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--gold-dim);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .btn-modal-close {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--gold-primary), #d4af37);
      border: none;
      border-radius: 16px;
      color: #000;
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      cursor: pointer;
      position: relative;
      z-index: 1;
      transition: transform 0.2s;
      box-shadow: 0 10px 20px -5px rgba(255, 215, 0, 0.4);
    }

    .btn-modal-close:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px -5px rgba(255, 215, 0, 0.5);
    }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

    /* Media Queries */
    @media (max-width: 768px) {
      .stats-deck { width: 100%; justify-content: space-around; gap: 0; padding: 15px 20px; }
      .stat-num { font-size: 1.5rem; }
      .modal-card { width: 95%; padding: 30px 20px; }
      .modal-title { font-size: 1.6rem; }
    }
  </style>
</head>
<body>
  <%- include('partials/loader') %>
  <nav class="navbar">
    <h2>Productivity Tracker</h2>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/calendar">‚≠êÔ∏è Calendar</a>
      <a href="/analytics">Analytics</a>
      <a href="/settings">Settings</a>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <% 
    const countCompleted = completed.length;
    const countConsistency = yetToCompleteConsistency.length;
    const countGoal = yetToCompleteGoal.length;
    // Add check for yetToCompleteHours in case it's undefined (though server should pass it)
    const countHours = typeof yetToCompleteHours !== 'undefined' ? yetToCompleteHours.length : 0;
    const totalCount = countCompleted + countConsistency + countGoal + countHours;
    const completionPercent = totalCount > 0 ? Math.round((countCompleted / totalCount) * 100) : 0;
  %>

  <div class="container">
    
    <div class="achievements-hero">
      <h1 class="hero-title">Hall of Fame</h1>
      <div class="stats-deck">
        <div class="stat-unit">
          <span class="stat-num highlight"><%= countCompleted %></span>
          <span class="stat-desc">Unlocked</span>
        </div>
        <div class="stat-unit">
          <span class="stat-num"><%= totalCount %></span>
          <span class="stat-desc">Total</span>
        </div>
        <div class="stat-unit">
          <span class="stat-num"><%= completionPercent %>%</span>
          <span class="stat-desc">Complete</span>
        </div>
      </div>
    </div>

    <% if (completed.length > 0) { %>
      <div class="category-header">
        <div class="category-icon-box"><i class="bi bi-trophy-fill"></i></div>
        <h2 class="category-title">Unlocked Achievements</h2>
      </div>

      <div class="grid-container">
        <% completed.forEach((achievement, index) => { %>
          <div class="ach-card unlocked" style="animation: scaleUp 0.5s ease-out backwards <%= index * 0.1 %>s">
            <div class="card-top">
              <div class="ach-icon-wrapper"><%- achievement.icon %></div>
              <div class="status-badge completed">Unlocked</div>
            </div>
            
            <div class="card-content">
              <h3><%= achievement.name %></h3>
              <p><%= achievement.description %></p>
            </div>

            <button class="btn-view-card" 
                    data-name="<%= achievement.name %>" 
                    data-description="<%= achievement.description %>"
                    data-type="<%= achievement.type %>"
                    data-goal-value="<%= achievement.goalValueOnAchieved %>"
                    data-icon='<%- achievement.icon %>'>
              View Card
            </button>
          </div>
        <% }) %>
      </div>
    <% } %>

    <% 
      const hasConsistency = yetToCompleteConsistency.length > 0;
      const hasGoal = yetToCompleteGoal.length > 0;
      const hasHours = typeof yetToCompleteHours !== 'undefined' && yetToCompleteHours.length > 0;
    %>

    <% if (hasConsistency || hasGoal || hasHours) { %>
      <div class="category-header" style="border-color: rgba(255,255,255,0.05);">
        <div class="category-icon-box" style="background: rgba(255,255,255,0.05); color: #666;"><i class="bi bi-lock-fill"></i></div>
        <h2 class="category-title" style="color: #666;">Locked Achievements</h2>
      </div>

      <div class="grid-container">
        
        <% 
           // Merge all locked lists for display
           let lockedList = [...yetToCompleteConsistency, ...yetToCompleteGoal];
           if (typeof yetToCompleteHours !== 'undefined') {
             lockedList = [...lockedList, ...yetToCompleteHours];
           }

           lockedList.forEach((achievement, index) => { 
             let progress = 0;
             let current = 0;
             let required = achievement.requiredDays; // Default
             let unit = 'Days';
             
             if (achievement.type === 'consistency') {
               current = longestConsistencyStreak;
               required = achievement.requiredDays;
               progress = Math.min(100, (current / required) * 100);
             } else if (achievement.type === 'goal') {
               current = longestGoalStreak;
               required = achievement.requiredDays;
               progress = Math.min(100, (current / required) * 100);
             } else if (achievement.type === 'total_hours') {
               current = Math.floor(totalStudyHours);
               required = achievement.requiredHours;
               unit = 'Hours';
               progress = Math.min(100, (current / required) * 100);
             }
        %>
          <div class="ach-card" style="animation: scaleUp 0.5s ease-out backwards <%= index * 0.1 %>s">
            <div class="card-top">
              <div class="ach-icon-wrapper"><%- achievement.icon %></div>
              <div class="status-badge" style="background: #222; color: #666;">Locked</div>
            </div>
            
            <div class="card-content">
              <h3><%= achievement.name %></h3>
              <p><%= achievement.description %></p>
              
              <div class="progress-track">
                <div class="progress-fill" style="width: <%= progress %>%;"></div>
              </div>
              <div class="progress-info">
                <span>Progress</span>
                <span><%= current %> / <%= required %> <%= unit %></span>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

  </div>

<script>
    // --- CANVAS-BASED PROFESSIONAL CONFETTI (Unchanged) ---
    function fireGoldConfetti() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.position = 'fixed';
      canvas.style.top = '0';
      canvas.style.left = '0';
      canvas.style.pointerEvents = 'none';
      canvas.style.zIndex = '10000';
      
      document.body.appendChild(canvas);

      const particles = [];
      const particleCount = 200;
      const colors = ['#FFD700', '#FDB931', '#ffffff', '#C0C0C0'];

      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * -canvas.height,
          w: Math.random() * 8 + 4,
          h: Math.random() * 6 + 4,
          dx: (Math.random() - 0.5) * 4,
          dy: Math.random() * 4 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          tilt: Math.floor(Math.random() * 10) - 10,
          tiltAngle: 0,
          tiltAngleIncremental: (Math.random() * 0.07) + 0.05
        });
      }

      function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, index) => {
          ctx.beginPath();
          ctx.lineWidth = p.w / 2;
          ctx.strokeStyle = p.color;
          ctx.moveTo(p.x + p.tilt + (p.w / 2), p.y);
          ctx.lineTo(p.x + p.tilt, p.y + p.tilt + (p.h / 2));
          ctx.stroke();

          p.tiltAngle += p.tiltAngleIncremental;
          p.y += p.dy;
          p.x += Math.sin(p.tiltAngle) * 2;
          p.tilt = Math.sin(p.tiltAngle) * 15;

          if (p.y > canvas.height) particles.splice(index, 1);
        });

        if (particles.length > 0) {
          requestAnimationFrame(render);
        } else {
          canvas.remove();
        }
      }
      render();
    }

    // --- NEW: MULTI-PLATFORM SHARE FUNCTION ---
    window.shareAchievement = async function(platform, name, description) {
      const text = `I just unlocked the "${name}" achievement on TrackU! üöÄ\n\n"${description}"\n\nLeveling up my productivity daily.`;
      const url = "https://tracku.me";
      const hashtags = "productivity,studygram,TrackU";
      
      const encodedText = encodeURIComponent(text);
      const encodedUrl = encodeURIComponent(url);

      switch(platform) {
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}&hashtags=${hashtags}`, '_blank');
          break;
          
        case 'whatsapp':
          // Works on both Web and Mobile
          window.open(`https://api.whatsapp.com/send?text=${encodedText}%20${encodedUrl}`, '_blank');
          break;
          
        case 'linkedin':
          // LinkedIn Feed Share
          window.open(`https://www.linkedin.com/feed/?shareActive=true&text=${encodedText}%20${encodedUrl}`, '_blank');
          break;
          
        case 'native':
          // The "Share to All Apps" functionality
          if (navigator.share) {
            try {
              await navigator.share({
                title: 'TrackU Achievement Unlocked!',
                text: text,
                url: url
              });
            } catch (err) {
              console.log('Share canceled or failed', err);
            }
          } else {
            // Fallback for desktop browsers without Web Share API
            navigator.clipboard.writeText(`${text} ${url}`);
            alert('Link and text copied to clipboard!');
          }
          break;
      }
    };

    // --- PROFESSIONAL MODAL OVERRIDE ---
    window.showAchievementPopup = function(name, description, type, goalValue, icon) {
      // 1. Remove existing popups
      const existing = document.querySelector('.modal-overlay');
      if (existing) existing.remove();

      // 2. Prepare Meta Info
      let metaHtml = '';
      if (type === 'goal' && goalValue) {
        metaHtml = `
          <div class="modal-meta-box">
            <div class="meta-row">
              <i class="bi bi-crosshair"></i>
              <span>Goal Target Met: ${goalValue} Hours/Day</span>
            </div>
          </div>
        `;
      }

      // 3. Construct the Premium Modal
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = (e) => { if(e.target === modal) closePopup(); };
      
      // Inline styles for share buttons to keep it self-contained
      const btnStyle = "flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; transition: transform 0.2s;";
      
      modal.innerHTML = `
        <div class="modal-card">
          <div class="god-ray"></div>
          
          <div class="modal-header-badge">Achievement Unlocked</div>
          
          <div class="modal-icon-lg">${icon}</div>
          
          <h2 class="modal-title">${name}</h2>
          <p class="modal-desc">${description}</p>
          
          ${metaHtml}
          
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;">
            <div style="display: flex; gap: 8px;">
                <button onclick="shareAchievement('twitter', '${name}', '${description}')" style="${btnStyle} background: #000; border: 1px solid #333;">
                    <i class="bi bi-twitter-x"></i> Post
                </button>
                
                <button onclick="shareAchievement('whatsapp', '${name}', '${description}')" style="${btnStyle} background: #25D366;">
                    <i class="bi bi-whatsapp"></i> Chat
                </button>

                <button onclick="shareAchievement('linkedin', '${name}', '${description}')" style="${btnStyle} background: #0077b5;">
                    <i class="bi bi-linkedin"></i> Post
                </button>
            </div>

            <button onclick="shareAchievement('native', '${name}', '${description}')" style="${btnStyle} background: rgba(255, 215, 0, 0.15); color: #FFD700; border: 1px solid rgba(255, 215, 0, 0.3);">
                <i class="bi bi-share-fill"></i> Share to other apps...
            </button>
          </div>

          <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
             <button class="btn-modal-close" onclick="closePopup()">Collect Reward</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // 4. Trigger PROFESSIONAL CONFETTI
      fireGoldConfetti();
    };

    // Override Close Function
    window.closePopup = function() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        modal.style.transition = 'opacity 0.3s';
        modal.style.opacity = '0';
        setTimeout(() => modal.remove(), 300);
      }
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Assuming 'checkAndShowAchievements' is defined in achievements.js
      if (typeof checkAndShowAchievements === 'function') {
          checkAndShowAchievements();
      }
      
      document.querySelectorAll('.btn-view-card').forEach(button => {
        button.addEventListener('click', () => {
          const name = button.getAttribute('data-name');
          const description = button.getAttribute('data-description');
          const type = button.getAttribute('data-type');
          const goalValue = button.getAttribute('data-goal-value');
          const icon = button.getAttribute('data-icon');
          showAchievementPopup(name, description, type, goalValue, icon);
        });
      });
    });
</script>
</body>
</html>