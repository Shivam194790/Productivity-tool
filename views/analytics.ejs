<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Productivity Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" href="/images/icon.svg" type="image/svg+xml">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* RESET & CORE FIXES */
    html, body {
        max-width: 100%;
        overflow-x: hidden;
    }
    * { box-sizing: border-box; }

    /* Responsive Grid (Used for Top and Bottom Rows) */
    .top-charts-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-half-width {
      flex: 1;
      min-width: 300px;
      background: #1e1e1e;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    /* Container adjustments inside blocks */
    .chart-half-width .chart-container {
      margin: 0;
      height: 100%;
      box-shadow: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      padding: 0;
      border: none;
    }

    /* TEXT STAT DISPLAY STYLE */
    .text-stat-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
        min-height: 180px;
        text-align: center;
    }
    .big-stat-number {
        font-size: 3.5rem;
        font-weight: bold;
        color: #4CAF50;
        margin: 10px 0;
        line-height: 1;
    }
    .big-stat-label {
        font-size: 1.1rem;
        color: #bbb;
        font-weight: 500;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .top-charts-row { flex-direction: column; gap: 15px; }
      .chart-half-width { width: 100%; min-width: 0; }
      .big-stat-number { font-size: 3rem; }
      .container { padding: 0 15px; }
    }
  </style>
</head>
<body>
  <%- include('partials/loader') %>
  <nav class="navbar">
    <h2>Productivity Tracker</h2>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/calendar">⭐️ Calendar</a>
      <a href="/analytics" class="active">Analytics</a>
      <a href="/settings">Settings</a>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <div class="container">
    <h1>Your Analytics</h1>
    <br>

    <div class="top-charts-row">
        <div class="chart-half-width">
            <div class="chart-container">
                <div class="chart-header-row" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                    <h2 style="font-size: 1.2rem; margin: 0;">Total Analysis</h2>
                    <select id="distributionRange" class="period-selector" style="font-size: 0.85rem; padding: 6px; max-width: 100%;">
                        <option value="past_7_days">Total (Past 7 Days)</option>
                        <option value="recent_30_days">Total (Recent 30 Days)</option>
                        <option value="past_6_months">Total (Past 6 Months)</option>
                        <option value="all_time_hours" selected>Total (All Time)</option>
                        <option disabled>──────────</option>
                        <option value="average_7_days">Avg (Past 7 Days)</option>
                        <option value="average_30_days">Avg (Past 30 Days)</option>
                        <option value="average_all_time">Avg (All Time)</option>
                    </select>
                </div>
                
                <div class="text-stat-wrapper">
                    <div class="big-stat-number" id="distValue">--</div>
                    <div class="big-stat-label" id="distLabel">Loading...</div>
                </div>
            </div>
        </div>

        <div class="chart-half-width">
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; flex-wrap: wrap;">
                    <h2 style="font-size: 1.2rem; margin: 0;">Monthly History</h2>
                    <span id="historyDateRange" style="font-size: 0.8em; color: #888;"></span>
                </div>
                <p style="color: #666; font-size: 0.8em; margin-bottom: 10px;">Swipe to view past months</p>
                
                <div class="scrollable-chart-outer" style="overflow-x: auto; width: 100%; flex-grow: 1;">
                    <div class="scrollable-chart-inner" style="position: relative; min-width: 100%; height: 250px;">
                        <canvas id="monthlyHistoryChart"></canvas>
                        <div id="historyNoData" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#888;">No Data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
     <div class="stat-card">
        <h3>Current Month Total</h3>
        <p class="stat-number"><%= currentMonthTotal %>h</p>
     </div>
      <div class="stat-card">
        <h3>Current Month Avg/Day</h3>
        <p class="stat-number"><%= currentMonthAvg %>h</p>
      </div>
      <div class="stat-card">
        <h3>Daily Goal</h3>
        <p class="stat-number"><%= user.dailyGoalHours %>h</p>
     </div>
    </div>

    <div class="chart-container">
      <h2>Last 30 Days Progress</h2>
      <div class="chart-wrapper"><canvas id="progressChart"></canvas></div>
    </div>

    <div class="chart-container">
      <h2>Custom Date Range Analysis</h2>
      <br>
      <div class="chart-controls">
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date">
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date">
        <button id="generate-range-chart" class="btn" style="width: auto; padding: 8px 16px;">Generate Chart</button>
      </div>
      <br>
      <div class="chart-wrapper"><canvas id="dateRangeChart"></canvas></div>
    </div>

    <div class="chart-container">
      <h2>Monthly Deep Dive</h2>
      <br>
      <div class="chart-controls">
        <label for="month-picker">Select Month:</label>
        <input type="month" id="month-picker">
      </div>
      <div class="chart-wrapper"><canvas id="monthlyChart"></canvas></div>
    </div>

    <div class="top-charts-row">
       <div class="chart-half-width">
          <div class="chart-container">
            <h2 id="dayOfWeekTitle">Productivity by Day</h2>
            <div class="chart-wrapper" style="flex-grow: 1; min-height: 250px; position: relative; margin-top: 10px;">
                <canvas id="dayOfWeekChart"></canvas>
            </div>
          </div>
      </div>
      <div class="chart-half-width">
          <div class="chart-container">
            <h2 id="goalAchievementTitle">Goal Achievement Rate</h2>
            <div class="chart-wrapper" style="flex-grow: 1; min-height: 250px; position: relative; margin-top: 10px;">
                <canvas id="goalAchievementChart"></canvas>
            </div>
          </div>
      </div>
    </div>

  </div>

  <script>
    // --- Global Chart Vars ---
    const dailyGoal = Number('<%= user.dailyGoalHours %>') || 5; 
    let progressChart, monthlyChart, dateRangeChart, dayOfWeekChart, goalAchievementChart, monthlyHistoryChart;

    // --- 1. Update Distribution TEXT ---
    async function updateDistributionStats(range) {
        const valEl = document.getElementById('distValue');
        const labelEl = document.getElementById('distLabel');
        
        valEl.style.opacity = '0.5';
        
        try {
            const response = await fetch(`/api/analytics?chart=distribution&range=${range}`);
            const data = await response.json();
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                 valEl.innerText = "0h";
                 labelEl.innerText = "No Data";
            } else {
                 const value = (data[0].value !== undefined && data[0].value !== null) ? data[0].value : 0;
                 const label = data[0].label || "Total";
                 
                 valEl.innerText = value + "h";
                 labelEl.innerText = label;
            }
        } catch (error) {
            console.error("Error fetching stats:", error);
            valEl.innerText = "Error";
        } finally {
            valEl.style.opacity = '1';
        }
    }

    // --- 2. History Chart (Scrollable) ---
    async function renderMonthlyHistoryChart() {
        try {
            const response = await fetch(`/api/analytics?chart=monthly_history`);
            const data = await response.json();

            if (!data || !Array.isArray(data) || data.length === 0) {
                 if(monthlyHistoryChart) monthlyHistoryChart.destroy();
                 document.getElementById('historyNoData').style.display = 'block';
                 return;
            } else {
                document.getElementById('historyNoData').style.display = 'none';
            }

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const labels = data.map(d => `${monthNames[d._id.month - 1]} '${String(d._id.year).slice(2)}`);
            const values = data.map(d => d.total);
            
            if (data.length > 0) {
                const first = data[0]._id;
                const last = data[data.length - 1]._id;
                document.getElementById('historyDateRange').innerText = 
                    `${monthNames[first.month-1]} ${first.year} - ${monthNames[last.month-1]} ${last.year}`;
            }

            const outer = document.querySelector('.scrollable-chart-outer');
            const inner = document.querySelector('.scrollable-chart-inner');
            const visibleMonths = 6;
            let chartWidth = '100%';
            if (data.length > visibleMonths) {
                chartWidth = `${(data.length / visibleMonths) * 100}%`;
            }
            inner.style.width = chartWidth;
            inner.style.height = '100%';
            
            const ctx = document.getElementById('monthlyHistoryChart').getContext('2d');
            if (monthlyHistoryChart) monthlyHistoryChart.destroy();

            monthlyHistoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total',
                        data: values,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: '#4CAF50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#ccc' } },
                        x: { grid: { display: false }, ticks: { color: '#ccc' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            setTimeout(() => { outer.scrollLeft = outer.scrollWidth; }, 100);

        } catch (error) { console.error(error); }
    }

    // --- Standard Charts ---
    function render30DayChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        const logs = <%- JSON.stringify(logs) %>;
        const labels = logs.map(log => new Date(log.date).toLocaleDateString());
        const data = logs.map(log => log.hours);
        
        if (progressChart) progressChart.destroy();
        progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hours',
                    data: data,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    tension: 0.4,
                    fill: true,
                    borderDash: [5, 5]
                 }, {
                    label: 'Goal',
                    data: Array(labels.length).fill(dailyGoal),
                    borderColor: '#FF5722',
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    async function renderDateRangeChart(startDate, endDate) {
        if (!startDate || !endDate) return;
        const response = await fetch(`/api/analytics?chart=dateRange&startDate=${startDate}&endDate=${endDate}`);
        const data = await response.json();
        
        if (dateRangeChart) dateRangeChart.destroy();
        const ctx = document.getElementById('dateRangeChart').getContext('2d');
        
        dateRangeChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(log => new Date(log.date).toLocaleDateString('en-CA', {timeZone: 'UTC'})),
            datasets: [{
                label: 'Hours',
                data: data.map(log => log.hours),
                backgroundColor: c => c.raw < dailyGoal ? 'rgba(255, 87, 34, 0.6)' : 'rgba(76, 175, 80, 0.6)',
                borderColor: c => c.raw < dailyGoal ? '#FF5722' : '#4CAF50',
                borderWidth: 1
              }, {
                type: 'line',
                label: 'Goal',
                data: Array(data.length).fill(dailyGoal),
                borderColor: '#fdc500', 
                borderDash: [5,5], 
                pointRadius: 0,
                fill: false
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
    }

    async function renderMonthlyChart(month) {
      const response = await fetch(`/api/analytics?chart=monthly&month=${month}`);
      const data = await response.json();
      
      if (monthlyChart) monthlyChart.destroy();
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      
      monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(log => new Date(log.date).toLocaleDateString('en-US', { day: 'numeric', timeZone: 'UTC' })),
          datasets: [{
            label: 'Hours',
            data: data.map(log => log.hours),
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            fill: true,
            pointStyle: data.map(log => log.hours < dailyGoal ? 'crossRot' : 'circle'),
            pointRadius: data.map(log => log.hours < dailyGoal ? 7 : 4),
            pointBorderColor: data.map(log => log.hours < dailyGoal ? '#FF5722' : '#4CAF50'),
            pointBackgroundColor: data.map(log => log.hours < dailyGoal ? '#FF5722' : '#4CAF50'),
            borderDash: [5, 5]
          }, {
            label: 'Goal',
            data: Array(data.length).fill(dailyGoal),
            borderColor: '#FF5722',
            borderDash: [5, 5],
            pointRadius: 0,
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    }

    async function renderDayOfWeekChart(month) {
      if (dayOfWeekChart) dayOfWeekChart.destroy();
      const response = await fetch(`/api/analytics?chart=dayOfWeek&month=${month}`);
      const data = await response.json();
      
      const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const chartData = Array(7).fill(0);
      data.forEach(item => { chartData[item._id - 1] = item.avgHours.toFixed(2); });
      
      const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
      dayOfWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayLabels,
          datasets: [{ label: 'Avg Hours', data: chartData, backgroundColor: 'rgba(253, 197, 0, 0.6)', borderColor: '#fdc500' }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
      });
      const monthName = new Date(`${month}-02T12:00:00Z`).toLocaleString('default', { month: 'long', timeZone: 'UTC' });
      document.getElementById('dayOfWeekTitle').innerText = `Productivity by Day (${monthName})`;
    }

    async function renderGoalAchievementChart(month) {
        if (goalAchievementChart) goalAchievementChart.destroy();
        const response = await fetch(`/api/analytics?chart=goalAchievement&month=${month}`);
        const data = await response.json();
        
        const ctx = document.getElementById('goalAchievementChart').getContext('2d');
        goalAchievementChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Met', 'Below'],
                datasets: [{ data: [data.met, data.notMet], backgroundColor: ['#4CAF50', '#FF5722'], borderColor: '#1e1e1e', borderWidth: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
        const monthName = new Date(`${month}-02T12:00:00Z`).toLocaleString('default', { month: 'long', timeZone: 'UTC' });
        document.getElementById('goalAchievementTitle').innerText = `Goal Achievement (${monthName})`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Init Top Widgets - Changed to all_time_hours default
      updateDistributionStats('all_time_hours');
      renderMonthlyHistoryChart();
      
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonthNum = today.getMonth() + 1;
      const currentMonthStr = `${currentYear}-${String(currentMonthNum).padStart(2, '0')}`;
      const todayStr = today.toISOString().split("T")[0];

      const monthPicker = document.getElementById('month-picker');
      if(monthPicker) {
          monthPicker.value = currentMonthStr;
          monthPicker.max = currentMonthStr;
      }

      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      if(startDateInput && endDateInput) {
          endDateInput.value = todayStr;
          endDateInput.max = todayStr;
          startDateInput.max = todayStr;
      }

      render30DayChart();
      renderMonthlyChart(currentMonthStr);
      renderDayOfWeekChart(currentMonthStr);
      renderGoalAchievementChart(currentMonthStr);
      
      if(monthPicker) {
          monthPicker.addEventListener('change', (e) => {
            const selectedMonth = e.target.value;
            renderMonthlyChart(selectedMonth);
            renderDayOfWeekChart(selectedMonth);
            renderGoalAchievementChart(selectedMonth);
          });
      }

      const generateBtn = document.getElementById('generate-range-chart');
      if(generateBtn) {
          generateBtn.addEventListener('click', () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (startDate && endDate && startDate <= endDate) {
                renderDateRangeChart(startDate, endDate);
            } else {
                alert('Please select a valid start and end date.');
            }
          });
      }

      const distRange = document.getElementById('distributionRange');
      if(distRange) {
          distRange.addEventListener('change', (e) => {
              updateDistributionStats(e.target.value);
          });
      }
    });
  </script>
</body>
</html>